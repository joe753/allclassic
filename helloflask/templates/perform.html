{% extends "layout.html" %}

{% block section %}
<button id="testbt">콜콜</button>
<div id="cards" class="row"> </div>

  <script id="card-template" type="text/x-handlebars-template">
    <!--Card-->
      <div class="card" style="height: 28rem">
          <!-- <div class="col-lg-4 col-md-4 border-right  border-light">
            <div class="view overlay" style="height:21rem;">
              <img src="{{ url_for('static', filename='img/trombone.jpg') }}"  class="card-img-left top_row"
                alt="" style="height: 16rem; width:15rem">
                <a>
                  <div class="mask rgba-white-slight ">
                  </div>
                </a>
            </div>
              <div class="text-center ml-1">
                  <h3>
                    <a>
                    <i class="far fa-star text-warning mx-4">
                    </i>
                    </a>
                    <a>
                      <i class="fas fa-share-alt text-muted mx-4">
                      </i>
                    </a>
                    <a>
                      <i class="fas fa-user-tag text-primary mx-4">
                      </i>
                    </a>
                  </h3>
              </div>
          </div> -->
          <div class="col-lg-12 col-md-4">
            <div class="text-center my-3  border-bottom ">
              <h5>
                {% raw %}
                <strong class="font-weight-bold" style="font-size : 24px ">
                    {{board_title}}
                </strong>
                {% endraw %}
              </h5>
            </div>
            <div class="row grey-text">
              <div class="col-lg-6 text-left text-dark">
                <h5>
                  <a>
                    <img src="{{ url_for('static', filename='img/user_img/user6.png') }}" style="height:2rem;  " class="rounded-circle">
                    {% raw %}
                    <strong class="ml-2 text-dark font-weight-bold" style="font-size : 22px;">{{user_nickname}}</strong>
                    {% endraw %}
                  </a>
                </h5>
              </div>
              <div class="col-lg-6 text-right">
                {% raw %}
                <h6 class="mr-2">
                    {{upload_date}}
                </h6>
                
              </div>
              
            </div>
            <div id="inst{{board_id}}" class="row" style="height: 8rem;">
              
                <!-- <div class="c_part col-lg-3">
                 <span class=" grey-text">
                   Oboe
                 </span>
                </div>
                <div class="c_part col-lg-3">
                 <span class=" grey-text">
                   Clarinet
                 </span>
                </div>
                <div class="c_part col-lg-3">
                 <span class=" text-primary">
                    Bassoon
                 </span>
                </div>
            </div>
            <div class="row">
              <div class="c_part col-lg-3">
               <span class=" text-primary">
                 Saxophone
               </span>
              </div>
              <div class="c_part col-lg-3">
               <span class=" grey-text">
                 Horn
               </span>
              </div>
              <div class="c_part col-lg-3">
               <span class=" grey-text">
                 Trumpet
               </span>
              </div>
              <div class="c_part col-lg-3">
               <span class=" text-primary">
                  Trombone
               </span>
              </div>
            </div>
            <div class="row">
              <div class="c_part col-lg-3">
               <span class=" text-primary">
                 Tuba
               </span>
              </div>
              <div class="c_part col-lg-3">
               <span class=" grey-text">
                 Percussion
               </span>
              </div>
              <div class="c_part col-lg-3">
               <span class=" grey-text">
                 Violin
               </span>
              </div>
              <div class="c_part col-lg-3">
               <span class=" text-primary">
                Viola
               </span>
              </div>
            </div>
            <div class="row">
              <div class="c_part col-lg-3">
               <span class=" text-primary">
                 Cello
               </span>
              </div>
              <div class="c_part col-lg-3">
               <span class=" grey-text">
                 Contrabass
               </span>
              </div>
              <div class="c_part col-lg-3">
               <span class=" grey-text">
                 Vocal
               </span>
              </div>
              <div class="c_part col-lg-3">
               <span class=" text-primary">
                Conductor/ &nbsp Composer
               </span>
              </div> -->
            </div> 
                <div class="row mt-4">
                  <div class="col-lg-12  grey-text text-center">
                    <h5 class="font-weight-bold">
                      {{due_date}}
                    </h5>
                  </div>
                  <div class="col-lg-12 text-center">
                      <h5 class="dark-grey-text font-weight-bold">
                        {{perform_address}}
                      </h5>
                  </div>
                  <div class="col-lg-12 text-dark text-center">
                      <h5 class="text-danger">
                        <strong class="font-weight-bold">{{money}}</strong> 원
                      </h5>

                        <div class="text-right">
                            <button type="button" class="btn btn-outline-default waves-effect float-left">
                              지원하기
                            </button>
                            <a id="link{{board_id}}">
                              <button id="detail{{board_id}}" type="button" class="btn btn-outline-info waves-effect">
                                  상세보기
                              </button>
                            </a>
                            {% endraw %}
                            <div class="modal fade" id="basicExampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                            aria-hidden="true">
                            <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body">
                            ...
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary">Save changes</button>
                          </div>
                        </div>
                      </div>
                    </div>

                        </div>
                  </div>
                </div>
            
          </div>


      </div>
    </div>
  </script>
   

<script>
var i = 0;
var num = 4; 
getall()


$(document).ready(function(){
  $(window).scroll(function(){   //스크롤이 최하단 으로 내려가면 리스트를 조회하고 page를 증가시킨다.
     if ($(window).scrollTop() >= $(document).height() - $(window).height()){
        getall()
     } 
  })
});





$("#testbt").click(function () {
  getall();
})

function addComma(num) {
  var regexp = /\B(?=(\d{3})+(?!\d))/g;
  return num.toString().replace(regexp, ',');
}

var alldata;
var boardinst_json = {}
var stopscroll;
var board_len

function getall () {
  if ( stopscroll == i ) {
    return ""
  }
  else if (alldata) {
    for (i; i < num; i++) {
        if (board_len == i) {
          break;
        }
        moment.locale('ko')
        console.log ("엘스이프", i, "board_len" , board_len)
        var kupload_time = moment(alldata.boardtb[i].upload_date)
        alldata.boardtb[i].upload_date = kupload_time.tz('UTC').format('YYYY.MM.DD a hh:mm')
        alldata.boardtb[i].due_date = kupload_time.tz('UTC').format('YYYY.MM.DD (dd) a hh:mm')
        alldata.boardtb[i].money = addComma(alldata.boardtb[i].money)
        var cardform = $('<div>')
        var cardnum = "card" + (board_len - i)
        cardform.addClass("col-lg-6").addClass("mb-3")
        cardform.attr("id", cardnum) 
        $("#cards").append(cardform)
        eee("card-template", alldata.boardtb[i], cardnum)
        var a = alldata.boardinst
        var result = a.filter( function (j) {
          return  j["board_id"] == (board_len - i)
        })
          boardinst_json["boardinst"] = result
          eee("hb_instsrc", boardinst_json, "inst" + (board_len - i))
        
        $('#link'+(board_len-i)).attr("href", "/perform/detail/board" + (board_len -i) )
        // $('#detail'+(board_len-i)).attr("onclick", "pf_detail(" + (board_len -i) + ")")
      }
    num = num + 2
  }
  else {
  $.ajax({
    url : "/alldata",
    data : "",
    type : 'GET',
    dataType : ''
    }).done(function (res){
      alldata = res
      board_len = alldata.boardtb.length
      for (i; i < num; i++) {
        if (board_len == i) {
          break;
        }
        moment.locale('ko')
        console.log ("아이아이아이", i)
        var kupload_time = moment(alldata.boardtb[i].upload_date)
        alldata.boardtb[i].upload_date = kupload_time.tz('UTC').format('YYYY.MM.DD a hh:mm')
        alldata.boardtb[i].due_date = kupload_time.tz('UTC').format('YYYY.MM.DD (dd) a hh:mm')
        alldata.boardtb[i].money = addComma(alldata.boardtb[i].money)
        var cardform = $('<div>')
        var cardnum = "card" + (board_len - i)
        cardform.addClass("col-lg-6").addClass("mb-3")
        cardform.attr("id", cardnum) 
        $("#cards").append(cardform)
        eee("card-template", alldata.boardtb[i], cardnum)
        var a = alldata.boardinst
        var result = a.filter( function (j) {
          return  j["board_id"] == (board_len - i)
        })
          boardinst_json["boardinst"] = result
          eee("hb_instsrc", boardinst_json, "inst" + (board_len - i))
        
        $('#link'+(board_len-i)).attr("href", "/perform/detail/board" + (board_len -i) )
        // $('#detail'+(board_len-i)).attr("onclick", "pf_detail(" + (board_len -i) + ")")
      }
      num = num + 2
    })
}
} 


</script>


<script id="hb_instsrc" type="text/x-handlebars-template">
  {% raw %}
  {{# each boardinst}}
  <div class="c_part col-lg-4" style="padding : 0px;">
    <span class=" text-primary my-4" style="font-size:16px">
      {{instrument_name}} ({{person}})
    </span>
  </div>
  {{/each}}
  {% endraw %}
</script>



<script>
function eee(sourceId, data, resultId){
  var source = document.getElementById(sourceId).innerHTML
  var template = Handlebars.compile(source);
  var html = template(data);
  document.getElementById(resultId).innerHTML = html;
}

function log_in (button_id) {
    if(confirm("로그인이 필요한 페이지 입니다.\n로그인하시겠습니까?") == true){
        $('#log_in').modal('show')
    }
    else{
        return ""
    }
}

function pf_detail (board_id) {
  var button_id= "#detail" + board_id
  $.ajax({ 
    url : "/perform/detail/board" + board_id,
    data : "",
    type : 'GET',
    dataType : ''
    }).done(function (res){
      if (res == "notlogin") {
        log_in(button_id)
      }
      else {
        window.location.href = 'http://localhost:5000/perform/detail/board' + board_id
      }
  })
}

</script>


{% endblock %}